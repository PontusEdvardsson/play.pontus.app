<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Upkeep - Snake</title>
  <style>
    :root {
      --bg: #0d1117; --panel: #0d1117; --fg: #c9d1d9; --muted: #8b949e;
      --border: #30363d; --btn-bg: #21262d; --btn-bg-hover: #30363d;
      --accent: #58a6ff; --track: #30363d; --white: #e6edf3;
    }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--fg);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    .wrap { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 24px; }
    .panel { position: relative; background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 20px; box-shadow: 0 0 0 1px rgba(255,255,255,0.02) inset; display: flex; flex-direction: column; align-items: center; gap: 14px; }
    .stage { position: relative; width: min(90vw, 960px); height: min(50vh, 360px); }

    /* Global nav buttons 1*/
    .nav { position: fixed; top: 16px; z-index: 10; font-size: 16px; padding: 12px 20px; border-radius: 8px; border: 1px solid var(--border); background: var(--btn-bg); color: var(--fg); text-decoration: none; display: inline-flex; align-items: center; justify-content: center; min-width: 88px; text-align: center; }
    .nav:hover { background: var(--btn-bg-hover); }
    .nav--next { right: 24px; }
    .nav--back { left: 24px; }

    #start { font-size: 18px; padding: 12px 16px; border-radius: 10px; border: 1px solid var(--border); background: var(--btn-bg); color: var(--fg); cursor: pointer; }
    #start:hover { background: var(--btn-bg-hover); }

    svg { display: block; width: 100%; height: 100%; touch-action: none; }
    .track { stroke: #c9d1d9; stroke-opacity: 0.7; stroke-width: 2; fill: none; }
    .knob { fill: var(--accent); stroke: #1b4b91; stroke-width: 2; filter: drop-shadow(0 0 8px rgba(88,166,255,0.25)); }
    .tip { position: absolute; right: 16px; top: 16px; color: var(--fg); font-size: 24px; font-weight: 600; }

    @media (max-width: 600px) {
      .wrap {
        padding: 16px;
      }
      .panel {
        width: 100%;
        max-width: 960px;
        padding: 16px;
      }
      .stage {
        width: 100%;
        height: 260px;
      }
      .tip {
        font-size: 20px;
        right: 12px;
        top: 12px;
      }
      #start {
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <a class="nav nav--back" id="backNav" href="upkeep-pump.html" title="Back">Back</a>
  <a class="nav nav--next" id="nextNav" href="upkeep-catch.html" title="Next">Next</a>

  <div class="wrap">
    <div class="panel">
      <button id="start" aria-label="Play" title="Play">&#9654;</button>
      <div class="stage">
        <svg viewBox="0 0 960 360" preserveAspectRatio="xMidYMid meet">
          <path id="snakeTrack" class="track" d="" />
          <circle id="knob" class="knob" r="10" cx="0" cy="0" />
        </svg>
        <div id="tip" class="tip">0%</div>
      </div>
      <audio id="rick" src="rick.mp3" preload="auto" loop></audio>
    </div>
  </div>

  <script>
    (function(){
      const startBtn = document.getElementById('start');
      const audio = document.getElementById('rick');
      const svg = document.querySelector('svg');
      const track = document.getElementById('snakeTrack');
      const knob = document.getElementById('knob');
      const tip = document.getElementById('tip');
      const backNav = document.getElementById('backNav');
      const nextNav = document.getElementById('nextNav');

      // Draw a snaking path across the stage (leftâ†’right)
      const W = 960, H = 360; // ViewBox
      const left = 40, right = W - 40; // padding
      const mid = H / 2;
      const amp1 = 90, amp2 = 50; // amplitudes for the wiggle
      function yAt(x){
        const t = (x - left) / (right - left); // 0..1
        return mid + Math.sin(t * Math.PI * 2) * amp1 * (1 - t*0.2) + Math.sin(t * Math.PI * 6) * amp2 * (0.6 + 0.4*t);
      }
      function buildPath(){
        const step = 8; let d = `M ${left} ${yAt(left).toFixed(2)}`;
        for(let x = left + step; x <= right; x += step){ d += ` L ${x} ${yAt(x).toFixed(2)}`; }
        track.setAttribute('d', d);
      }
      buildPath();

      // Draggable knob following the snake track
      let level = 0; // 0..100
      let dragging = false;
      let dragOffsetPx = 0; // pointer X minus knob center X in local px
      function clamp(v,min,max){ return v < min ? min : v > max ? max : v; }
      function trySetLevelFromPointer(e, useOffset){
        const bbox = svg.getBoundingClientRect();
        const localX = clamp(e.clientX - bbox.left - (useOffset ? dragOffsetPx : 0), 0, bbox.width);
        const localY = clamp(e.clientY - bbox.top, 0, bbox.height);
        const p = localX / bbox.width; // 0..1
        const xV = left + (right - left) * p; // viewBox X
        const yV = yAt(xV); // expected Y on track (viewBox)
        const yFromPointerV = (localY / bbox.height) * H; // viewBox Y
        const dist = Math.abs(yFromPointerV - yV);
        const THRESH = 18; // px in viewBox units
        if (dist <= THRESH) {
          level = Math.round(p * 100);
          render();
          return true;
        }
        return false;
      }
      function knobPosFromLevel(){
        const x = left + (right - left) * (level / 100);
        const y = yAt(x);
        return {x, y};
      }
      function render(){
        const {x,y} = knobPosFromLevel();
        knob.setAttribute('cx', x);
        knob.setAttribute('cy', y);
        audio.volume = mapVolume(level);
        tip.textContent = level + '%';
      }
      // Only start dragging by grabbing the knob
      knob.style.cursor = 'grab';
      knob.addEventListener('pointerdown', (e)=>{
        const bbox = svg.getBoundingClientRect();
        const localX = clamp(e.clientX - bbox.left, 0, bbox.width);
        const knobLocalX = (level/100) * bbox.width;
        dragOffsetPx = localX - knobLocalX;
        dragging = true;
        knob.style.cursor = 'grabbing';
        try{ svg.setPointerCapture(e.pointerId); }catch(_){ }
        e.stopPropagation();
      });
      // Ignore clicks on the track so the knob doesn't jump
      svg.addEventListener('pointerdown', (e)=>{ /* no-op */ });
      svg.addEventListener('pointermove', (e)=>{ if(dragging) trySetLevelFromPointer(e, true); });
      svg.addEventListener('pointerup',   (e)=>{ dragging = false; knob.style.cursor = 'grab'; try{ svg.releasePointerCapture(e.pointerId); }catch(_){}});

      // Audio normalization curve
      function mapVolume(val){
        const x = Math.max(0, Math.min(1, val/100));
        const gamma = 2.2; const cap = 0.75; const v = Math.pow(x, gamma);
        return Math.max(0, Math.min(cap, v));
      }

      // Optional compressor
      let ctx, sourceNode, compressor, isPlaying=false;
      function setupAudioGraph(){
        if (ctx) return;
        const AC = window.AudioContext || window.webkitAudioContext; if (!AC) return;
        ctx = new AC();
        sourceNode = ctx.createMediaElementSource(audio);
        compressor = ctx.createDynamicsCompressor();
        compressor.threshold.value = -24; compressor.knee.value = 30; compressor.ratio.value = 12; compressor.attack.value = 0.003; compressor.release.value = 0.25;
        sourceNode.connect(compressor); compressor.connect(ctx.destination);
      }

      startBtn.addEventListener('click', async ()=>{
        if(!isPlaying){
          setupAudioGraph();
          audio.volume = mapVolume(level);
          try{ await audio.play(); }catch(_){ return; }
          isPlaying = true; startBtn.textContent='\u23F8'; startBtn.title='Pause';
          if(ctx && ctx.state==='suspended') ctx.resume();
        }else{
          audio.pause(); isPlaying=false; startBtn.textContent='\u25B6'; startBtn.title='Play';
        }
      });

      // Initialize
      render();

      // Next simply moves forward in the carousel to the catch game
      nextNav.addEventListener('click', (e)=>{
        e.preventDefault();
        location.href = 'upkeep-catch.html';
      });
    })();
  </script>
</body>
</html>
