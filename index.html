<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Upkeep</title>
  <style>
    :root {
      --bg: #0d1117;
      --panel: #0d1117;
      --fg: #c9d1d9;
      --muted: #8b949e;
      --border: #30363d;
      --accent: #58a6ff;
      --btn-bg: #21262d;
      --btn-bg-hover: #30363d;
      --thumb: #58a6ff;
      --track: #30363d;
      --track-fill: #1f6feb;
    }

    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    .wrap {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      /* Nudge the content slightly upward for nicer balance*/
      transform: translateY(-6vh);
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px 28px;
      box-shadow: 0 0 0 1px rgba(255,255,255,0.02) inset;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 16px;
    }

    h1 { margin: 0; font-size: 20px; font-weight: 600; text-align: center; }

    .row { display: flex; align-items: center; justify-content: center; gap: 12px; }

    .tooltip { width: 48px; text-align: right; color: var(--muted); }
    .note { font-size: 12px; color: var(--muted); margin-top: 8px; }

    #start {
      font-size: 14px; padding: 10px 16px; cursor: pointer;
      border: 1px solid var(--border); background: var(--btn-bg); border-radius: 8px;
      color: var(--fg);
    }
    #start:hover { background: var(--btn-bg-hover); }
    #start:disabled { opacity: 0.6; cursor: default; }

    input[type="range"] { width: 360px; height: 24px; }
    input[type="range"] {
      -webkit-appearance: none;
      background: transparent;
    }
    input[type="range"]::-webkit-slider-runnable-track {
      height: 6px;
      background: var(--track);
      border-radius: 999px;
    }
    input[type="range"]::-moz-range-track {
      height: 6px; background: var(--track); border-radius: 999px;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      margin-top: -6px;
      width: 18px; height: 18px; border-radius: 50%;
      background: var(--thumb); border: 2px solid #1b4b91;
      box-shadow: 0 0 0 4px rgba(88, 166, 255, 0.15);
      cursor: pointer;
    }
    input[type="range"]::-moz-range-thumb {
      width: 18px; height: 18px; border-radius: 50%;
      background: var(--thumb); border: 2px solid #1b4b91; cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <h1>Upkeep</h1>
      <button id="start" aria-label="Play" title="Play">&#9654;</button>

      <div class="row">
        <input id="vol" type="range" min="0" max="100" value="70" step="1" />
        <div id="tooltip" class="tooltip">70%</div>
      </div>
      

      <!-- Hidden audio; ensure rick.mp3 exists next to this file -->
      <audio id="rick" src="rick.mp3" preload="auto" loop></audio>
    </div>
  </div>

  <script>
    (function () {
      const slider = document.getElementById('vol');
      const tip = document.getElementById('tooltip');
      const start = document.getElementById('start');
      const audio = document.getElementById('rick');
      let tickTimer = null;
      let isPlaying = false;
      // Optional loudness normalization via DynamicsCompressor
      let ctx, sourceNode, compressor;

      function mapVolume(val) {
        // Gentler curve: more control near 0, cap top end
        const x = Math.max(0, Math.min(1, val / 100));
        const gamma = 2.2; // perceptual-ish
        const cap = 0.75;  // avoid ear-piercing full scale
        const v = Math.pow(x, gamma);
        return Math.max(0, Math.min(cap, v));
      }

      function updateFakeTooltip(val) {
        tip.textContent = Math.max(0, Math.min(100, Math.round(val))) + '%';
      }

      // Initialize audio volume to mapped slider value
      (function initVolume() {
        const initV = mapVolume(Number(slider.value));
        audio.volume = initV;
        updateFakeTooltip(Number(slider.value));
      })();

      slider.addEventListener('input', (e) => {
        const val = Number(e.target.value);
        updateFakeTooltip(val);
        const v = mapVolume(val);
        audio.volume = v;
      });

      // Removed random hover nudge to prevent unexpected jumps

      // Tick down 1% every second while playing
      function startTickDown() {
        if (tickTimer) return;
        tickTimer = setInterval(() => {
          let n = Number(slider.value);
          if (n <= 0) return; // keep running; user may raise it
          n = n - 1;
          slider.value = String(n);
          const v = Number(slider.value);
          updateFakeTooltip(v);
          audio.volume = mapVolume(v);
        }, 1000);
      }
      function stopTickDown() {
        if (!tickTimer) return;
        clearInterval(tickTimer);
        tickTimer = null;
      }

      function setupAudioGraph() {
        if (ctx) return;
        const AC = window.AudioContext || window.webkitAudioContext;
        if (!AC) return;
        ctx = new AC();
        sourceNode = ctx.createMediaElementSource(audio);
        compressor = ctx.createDynamicsCompressor();
        compressor.threshold.value = -24;
        compressor.knee.value = 30;
        compressor.ratio.value = 12;
        compressor.attack.value = 0.003;
        compressor.release.value = 0.25;
        sourceNode.connect(compressor);
        compressor.connect(ctx.destination);
      }

      // Play/Pause toggle button
      start.addEventListener('click', async () => {
        if (!isPlaying) {
          setupAudioGraph();
          audio.volume = mapVolume(Number(slider.value));
          try {
            await audio.play();
          } catch (err) {
            // If blocked, hint but keep button
            start.textContent = '\u25B6';
            start.title = 'Play';
            start.setAttribute('aria-label', 'Play');
            return;
          }
          isPlaying = true;
          start.textContent = '\u23F8';
          start.title = 'Pause';
          start.setAttribute('aria-label', 'Pause');
          if (ctx && ctx.state === 'suspended') ctx.resume();
          startTickDown();
        } else {
          audio.pause();
          isPlaying = false;
          start.textContent = '\u25B6';
          start.title = 'Play';
          start.setAttribute('aria-label', 'Play');
          stopTickDown();
        }
      });

      // Optional: basic error surfacing if the file is missing
      audio.addEventListener('error', () => {
        const msg = document.createElement('div');
        msg.className = 'note';
        msg.textContent = 'Could not load rick.mp3. Place it next to index.html';
        document.querySelector('.panel').appendChild(msg);
      });
    })();
  </script>
</body>
</html>
